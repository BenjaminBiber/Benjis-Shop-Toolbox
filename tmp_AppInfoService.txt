using Microsoft.EntityFrameworkCore;
using Toolbox.Data.Common;
using Toolbox.DataContexts;

namespace Toolbox.Data.Services;

public class AppInfoService
{
    private readonly InternalAppDbContext? _db;

    public AppInfoService(InternalAppDbContext? db = null)
    {
        _db = db;
    }

    public async Task<AppInfo> GetAsync(CancellationToken cancellationToken = default)
    {
        if (_db == null)
        {
            return new AppInfo
            {
                StartTime = DateTime.Now,
                AppVersion = "0.0.0"
            };
        }

        await _db.Database.EnsureCreatedAsync(cancellationToken);
        var info = await _db.Set<AppInfo>().AsNoTracking().FirstOrDefaultAsync(cancellationToken);
        return info ?? new AppInfo
        {
            StartTime = DateTime.Now,
            AppVersion = "0.0.0"
        };
    }

    public async Task SetStartTimeAsync(DateTime startTime, CancellationToken cancellationToken = default)
    {
        if (_db == null)
        {
            return;
        }

        await _db.Database.EnsureCreatedAsync(cancellationToken);
        var set = _db.Set<AppInfo>();
        var info = await set.FirstOrDefaultAsync(cancellationToken);
        if (info == null)
        {
            info = new AppInfo { StartTime = startTime, AppVersion = "0.0.0" };
            await set.AddAsync(info, cancellationToken);
        }
        else
        {
            info.StartTime = startTime;
            set.Update(info);
        }
        await _db.SaveChangesAsync(cancellationToken);
    }
}

