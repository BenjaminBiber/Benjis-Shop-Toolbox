@page "/sites"
@using Benjis_Shop_Toolbox.Models
@using Benjis_Shop_Toolbox.Services
@using Microsoft.Web.Administration
@inject SettingsService SettingsService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject FileDialogService FileDialog
@using ElectronApp.Components.Dialogs
@using ElectronNET.API.Entities

<MudPaper Class="pa-4" Elevation="4">
    <div class="d-flex justify-content-end mb-2">
        <MudIconButton Icon="@Icons.Material.Filled.Add" Color="Color.Primary" OnClick="OpenAddDialog" />
    </div>
    @if (GroupedSites.Count == 0)
    {
        <MudAlert Severity="Severity.Info">Keine IIS Sites vorhanden.</MudAlert>
    }
    else
    {
        @foreach (var group in GroupedSites)
        {
            <div class="d-flex align-items-center mb-2">
                <MudText Typo="Typo.h6" Class="me-2">@group.Key</MudText>
                <MudSpacer />
                <MudIconButton Icon="@Icons.Material.Filled.Start" Color="Color.Success" OnClick="@(() => StartGroup(group.Value))" />
                <MudIconButton Icon="@Icons.Material.Filled.RestartAlt" Color="Color.Warning" OnClick="@(() => RestartGroup(group.Value))" />
                <MudIconButton Icon="@Icons.Material.Filled.Stop" Color="Color.Error" OnClick="@(() => StopGroup(group.Value))" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete" Class="ml-4" Color="Color.Info" OnClick="@(() => DeleteGroup(group.Key))" />
            </div>
            <MudTable Items="group.Value" Hover="true" Class="mb-6" Dense="true">
                <HeaderContent>
                    <MudTh>Name</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>Shop</MudTh>
                    <MudTh>shop.yaml</MudTh>
                    <MudTh>Themes</MudTh>
                    <MudTh></MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Name">@context</MudTd>
                    <MudTd DataLabel="Status">
                        <MudChip T="string" Color="@GetStateColor(GetSiteState(context))" Variant="Variant.Filled">@GetSiteState(context)</MudChip>
                    </MudTd>
                    <MudTd>
                        <MudCheckBox Value="GetSiteSetting(context).IsShop" ValueChanged="@((bool v) => ToggleShop(context, v))" />
                    </MudTd>
                    <MudTd DataLabel="shop.yaml">@GetSiteSetting(context).ShopYamlPath</MudTd>
                    <MudTd DataLabel="Themes">@GetSiteSetting(context).ShopThemesPath</MudTd>
                    <MudTd>
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" Disabled="!GetSiteSetting(context).IsShop" OnClick="@(() => OpenPathsDialog(context))" />
                        <MudIconButton Icon="@Icons.Material.Filled.Start" Color="Color.Success" OnClick="@(() => StartSite(context))" />
                        <MudIconButton Icon="@Icons.Material.Filled.RestartAlt" Color="Color.Warning" OnClick="@(() => RestartSite(context))" />
                        <MudIconButton Icon="@Icons.Material.Filled.Stop" Color="Color.Error" OnClick="@(() => StopSite(context))" />
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
    }
</MudPaper>

@code {
    private TimeSpan RestartDelay =>
        TimeSpan.FromSeconds(Math.Max(1, Settings.RestartDelaySeconds));
    private ServerManager _manager = new();

    private Dictionary<string, List<string>> GroupedSites { get; set; } = new();

    private async Task OpenAddDialog()
    {
        var dlg = DialogService.Show<AddSiteGroupDialog>("Gruppe hinzufügen");
        var result = await dlg.Result;
        if (!result.Canceled)
        {
            LoadGroups();
            StateHasChanged();
        }
    }

    protected override void OnInitialized()
    {
        LoadGroups();
    }

    private void LoadGroups()
    {
        _manager = new ServerManager();
        var allSites = _manager.Sites.Select(s => s.Name).ToList();
        GroupedSites = new();

        foreach (var group in Settings.SiteGroups)
        {
            var existing = group.Sites.Where(allSites.Contains).ToList();
            if (existing.Count > 0)
            {
                GroupedSites[group.Name] = existing;
            }
        }

        if (allSites.Any(x => !GroupedSites.Values.Any(c => c.Contains(x))))
        {
            GroupedSites["Ungruppiert"] = allSites.Where(x => !GroupedSites.Values.Any(c => c.Contains(x))).ToList();
        }
    }

    private ObjectState GetSiteState(string name)
    {
        return _manager.Sites[name]?.State ?? ObjectState.Stopped;
    }

    private Color GetStateColor(ObjectState state) => state switch
    {
        ObjectState.Started => Color.Success,
        ObjectState.Starting => Color.Warning,
        ObjectState.Stopped => Color.Error,
        ObjectState.Stopping => Color.Warning,
        _ => Color.Default
    };

    private void StartSite(string name, bool reloadGroups = true)
    {
        try
        {
            using var manager = new ServerManager();
            manager.Sites[name]?.Start();
            Snackbar.Add($"Anwendung {name} gestartet.", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fehler beim Starten: {ex.Message}", Severity.Error);
        }
        if (reloadGroups)
        {
            LoadGroups();
            StateHasChanged();
        }
    }

    private void StopSite(string name, bool reloadGroups = true)
    {
        try
        {
            using var manager = new ServerManager();
            manager.Sites[name]?.Stop();
            Snackbar.Add($"Anwendung '{name}' gestoppt.", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fehler beim Stoppen: {ex.Message}", Severity.Error);
        }
        if (reloadGroups)
        {
            LoadGroups();
            StateHasChanged();
        }
    }

    private async Task RestartSite(string name, bool reloadGroups = true)
    {
        StopSite(name, false);
        RecycleAppPool(name);
        await Task.Delay(RestartDelay);
        StartSite(name, false);
        if (reloadGroups)
        {
            LoadGroups();
            StateHasChanged();
        }
    }

    private void RecycleAppPool(string appPoolName)
    {
        try
        {
            using var manager = new ServerManager();
            var pool = manager.ApplicationPools.FirstOrDefault(p => p.Name == appPoolName);
            if (pool == null)
            {
                Snackbar.Add($"AppPool '{appPoolName}' nicht gefunden.", Severity.Warning);
                return;
            }

            if (pool.State == ObjectState.Stopped)
                pool.Start();
            else
                pool.Recycle();

            Snackbar.Add($"AppPool '{appPoolName}' recycelt.", Severity.Info);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fehler beim AppPool-Recycling: {ex.Message}", Severity.Error);
        }
    }

    private void StartGroup(IEnumerable<string> sites)
    {
        foreach (var site in sites)
        {
            StartSite(site, false);
        }
        LoadGroups();
        StateHasChanged();
    }

    private void StopGroup(IEnumerable<string> sites)
    {
        foreach (var site in sites)
        {
            StopSite(site, false);
        }
        LoadGroups();
        StateHasChanged();
    }

    private async Task RestartGroup(IEnumerable<string> sites)
    {
        foreach (var site in sites)
        {
            await RestartSite(site, false);
        }
        LoadGroups();
        StateHasChanged();
    }

    private void DeleteGroup(string groupName)
    {
        if (Settings.SiteGroups.RemoveAll(g => g.Name == groupName) > 0)
        {
            SettingsService.Save();
            LoadGroups();
            Snackbar.Add($"Gruppe '{groupName}' gelöscht.", Severity.Success);
        }
        else
        {
            Snackbar.Add($"Gruppe '{groupName}' nicht gefunden.", Severity.Warning);
        }
    }

    private SiteSetting GetSiteSetting(string name)
    {
        var setting = Settings.SiteSettings.FirstOrDefault(s => s.Name == name);
        if (setting == null)
        {
            setting = new SiteSetting { Name = name };
            Settings.SiteSettings.Add(setting);
        }
        return setting;
    }

    private void ToggleShop(string name, bool value)
    {
        var setting = GetSiteSetting(name);
        setting.IsShop = value;
        SettingsService.Save();
    }

    private void UpdateYamlPath(string name, string path)
    {
        var setting = GetSiteSetting(name);
        setting.ShopYamlPath = path;
        SettingsService.Save();
    }

    private void ChooseYaml(string name)
    {
        var filters = new FileFilter[]
        {
            new FileFilter { Name = "YAML", Extensions = new[] { "yaml", "yml" } }
        };
        var initialDir = Path.GetDirectoryName(GetSiteSetting(name).ShopYamlPath) ?? string.Empty;
        var path = FileDialog.OpenFile("shop.yaml auswählen", filters, initialDir);
        if (!string.IsNullOrEmpty(path))
        {
            UpdateYamlPath(name, path);
            StateHasChanged();
        }
    }

    private async Task OpenPathsDialog(string name)
    {
        var parameters = new DialogParameters { ["SiteName"] = name };
        var dlg = DialogService.Show<SitePathsDialog>("Shop Pfade", parameters);
        var result = await dlg.Result;
        if (!result.Canceled)
        {
            StateHasChanged();
        }
    }

    private ToolboxSettings Settings => SettingsService.Settings;
}
