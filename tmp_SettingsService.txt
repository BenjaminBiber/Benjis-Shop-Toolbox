using System.Text.Json;
using Microsoft.EntityFrameworkCore;
using Toolbox.Data.Common;
using Toolbox.DataContexts;
using Toolbox.Data.Entities;
using Toolbox.Data.Models;

namespace Toolbox.Data.Services;

public class SettingsService
{
    private readonly InternalAppDbContext _db;
    public ToolboxSettings Settings { get; private set; }
    public bool IsConfigured { get; private set; }

    public SettingsService(InternalAppDbContext db)
    {
        _db = db;
        Settings = Load();
    }

    private ToolboxSettings Load(string? _ = null)
    {
        try
        {
            _db.Database.EnsureCreated();
            // Prefer the relational model over legacy JSON record
            var entity = _db.ToolboxSettings
                .Include(s => s.SiteSettings)
                .Include(s => s.SiteGroups)
                    .ThenInclude(g => g.Sites)
                .AsNoTracking()
                .FirstOrDefault();

            if (entity != null)
            {
                var model = MapToModel(entity);
                IsConfigured = !string.IsNullOrWhiteSpace(model.IisAppName)
                               && !string.IsNullOrWhiteSpace(model.LogName);
                return model;
            }

            // Fallback: legacy JSON record if present (one-time compatibility)
            var record = _db.AppSettings.AsNoTracking().FirstOrDefault();
            if (record != null)
            {
                var fromDb = JsonSerializer.Deserialize<ToolboxSettings>(record.Json);
                if (fromDb != null)
                {
                    IsConfigured = !string.IsNullOrWhiteSpace(fromDb.IisAppName)
                                   && !string.IsNullOrWhiteSpace(fromDb.LogName);
                    return fromDb;
                }
            }
        }
        catch
        {
            // ignore and return defaults
        }

        IsConfigured = false;
        return new ToolboxSettings();
    }

    public bool LoadSettingsFromExport()
    {
        var downloads = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.UserProfile), "Downloads");
        var files = Directory.GetFiles(downloads);
        var candidate = files.Where(x => x.Contains("Toolbox-Settings-"))
                             .OrderByDescending(x => x)
                             .FirstOrDefault();
        if (candidate == null)
            return false;

        return Import(candidate);
    }

    public bool Save(string? iis = null, string? repoPath = null, string? shopPath = null)
    {
        if (!string.IsNullOrEmpty(iis))
            Settings.IisAppName = iis;

        if (!string.IsNullOrEmpty(repoPath))
            Settings.RepoPath = repoPath;

        if (!string.IsNullOrEmpty(shopPath))
            Settings.ShopThemesPath = shopPath;

        try
        {
            _db.Database.EnsureCreated();

            var entity = _db.ToolboxSettings
                .Include(s => s.SiteSettings)
                .Include(s => s.SiteGroups)
                    .ThenInclude(g => g.Sites)
                .FirstOrDefault();

            if (entity == null)
            {
                entity = MapToEntity(Settings);
                _db.ToolboxSettings.Add(entity);
            }
            else
            {
                // Update scalar fields
                UpdateEntityScalar(entity, Settings);

                // Replace SiteSettings
                _db.SiteSettings.RemoveRange(entity.SiteSettings);
                entity.SiteSettings.Clear();
                entity.SiteSettings.AddRange(Settings.SiteSettings.Select(ss => new SiteSettingEntity
                {
                    Name = ss.Name,
                    IsShop = ss.IsShop,
                    ShopYamlPath = ss.ShopYamlPath,
                    ShopThemesPath = ss.ShopThemesPath
                }));

                // Replace SiteGroups and Sites
                foreach (var g in entity.SiteGroups.ToList())
                {
                    _db.SiteGroupSites.RemoveRange(g.Sites);
                }
                _db.SiteGroups.RemoveRange(entity.SiteGroups);
                entity.SiteGroups.Clear();
                foreach (var sg in Settings.SiteGroups)
                {
                    var group = new SiteGroupEntity { Name = sg.Name };
                    group.Sites.AddRange(sg.Sites.Select(s => new SiteGroupSiteEntity { SiteName = s }));
                    entity.SiteGroups.Add(group);
                }
            }

            _db.SaveChanges();

            IsConfigured = !string.IsNullOrWhiteSpace(Settings.IisAppName) &&
                           !string.IsNullOrWhiteSpace(Settings.LogName);
            return true;
        }
        catch
        {
            return false;
        }

    }

    private static ToolboxSettings MapToModel(ToolboxSettingsEntity e)
    {
        return new ToolboxSettings
        {
            IisAppName = e.IisAppName,
            LogName = e.LogName,
            AutoRefreshSeconds = e.AutoRefreshSeconds,
            AutoRefreshEnabled = e.AutoRefreshEnabled,
            LoadOnStartup = e.LoadOnStartup,
            OnlySinceRestart = e.OnlySinceRestart,
            RepoPath = e.RepoPath,
            ShopThemesPath = e.ShopThemesPath,
            ShopYamlPath = e.ShopYamlPath,
            RestartShopOnThemeChange = e.RestartShopOnThemeChange,
            RestartDelaySeconds = e.RestartDelaySeconds,
            BundleLogs = e.BundleLogs,
            SiteSettings = e.SiteSettings.Select(ss => new Toolbox.Data.Models.SiteSetting
            {
                Name = ss.Name,
                IsShop = ss.IsShop,
                ShopYamlPath = ss.ShopYamlPath,
                ShopThemesPath = ss.ShopThemesPath
            }).ToList(),
            SiteGroups = e.SiteGroups.Select(g => new Toolbox.Data.Models.SiteGroup
            {
                Name = g.Name,
                Sites = g.Sites.Select(s => s.SiteName).ToList()
            }).ToList()
        };
    }

    private static ToolboxSettingsEntity MapToEntity(ToolboxSettings s)
    {
        var entity = new ToolboxSettingsEntity();
        UpdateEntityScalar(entity, s);
        entity.SiteSettings.AddRange(s.SiteSettings.Select(ss => new SiteSettingEntity
        {
            Name = ss.Name,
            IsShop = ss.IsShop,
            ShopYamlPath = ss.ShopYamlPath,
            ShopThemesPath = ss.ShopThemesPath
        }));
        foreach (var sg in s.SiteGroups)
        {
            var group = new SiteGroupEntity { Name = sg.Name };
            group.Sites.AddRange(sg.Sites.Select(name => new SiteGroupSiteEntity { SiteName = name }));
            entity.SiteGroups.Add(group);
        }
        return entity;
    }

    private static void UpdateEntityScalar(ToolboxSettingsEntity entity, ToolboxSettings s)
    {
        entity.IisAppName = s.IisAppName;
        entity.LogName = s.LogName;
        entity.AutoRefreshSeconds = s.AutoRefreshSeconds;
        entity.AutoRefreshEnabled = s.AutoRefreshEnabled;
        entity.LoadOnStartup = s.LoadOnStartup;
        entity.OnlySinceRestart = s.OnlySinceRestart;
        entity.RepoPath = s.RepoPath;
        entity.ShopThemesPath = s.ShopThemesPath;
        entity.ShopYamlPath = s.ShopYamlPath;
        entity.RestartShopOnThemeChange = s.RestartShopOnThemeChange;
        entity.RestartDelaySeconds = s.RestartDelaySeconds;
        entity.BundleLogs = s.BundleLogs;
    }

    public bool Import(string path)
    {
        try
        {
            if (!File.Exists(path))
                return false;

            var json = File.ReadAllText(path);
            var settings = JsonSerializer.Deserialize<ToolboxSettings>(json);
            if (settings == null)
                return false;

            Settings = settings;
            return Save();
        }
        catch
        {
            return false;
        }
    }

    public bool Export()
    {
        try
        {
            var downloads = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.UserProfile), "Downloads");
            Directory.CreateDirectory(downloads);
            var fileName = $"Toolbox-Settings-{DateTime.Now:yyyy-MM-dd}.json";
            var destPath = Path.Combine(downloads, fileName);
            var json = JsonSerializer.Serialize(Settings, new JsonSerializerOptions { WriteIndented = true });
            File.WriteAllText(destPath, json);
            return true;
        }
        catch
        {
            return false;
        }
    }
}

