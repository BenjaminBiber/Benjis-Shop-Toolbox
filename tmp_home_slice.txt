                    Time = log.Time,
                    Level = log.Level,
                    Message = log.Message,
                    Count = log.Count,
                    ParsedMessage = log.ParsedMessage
                };
            }
        }
        if (current != null)
        {
            yield return current;
        }
    }

    private MarkupString Highlight(string message)
    {
        if (string.IsNullOrWhiteSpace(_searchText))
        {
            return (MarkupString)System.Net.WebUtility.HtmlEncode(message);
        }

        var encoded = System.Net.WebUtility.HtmlEncode(message);
        var pattern = System.Text.RegularExpressions.Regex.Escape(_searchText);
        var highlighted = System.Text.RegularExpressions.Regex.Replace(encoded, pattern,
            m => $"<mark>{m.Value}</mark>", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        return (MarkupString)$"<span style=\"font-size:smaller\">{highlighted}</span>";

    }

    protected override async Task OnInitializedAsync()
    {
        var appInfo = await AppInfoService.GetAsync();
        _appStartTime = appInfo.StartTime;
       
        if (SettingsService.IsConfigured)
        {
            await ApplySettings();
        }
        
        if ((DateTime.Now - appInfo.IisRestartTime).Hours >= 1)
        {
            var tmp = reload;
            reload = ReloadOption.AlleLogs;
            await LoadLogs();
            reload = tmp;
        }
    }

    private async Task ApplySettings()
    {
        _logService = new LogService(Settings.LogName!);
        _autoRefresh = Settings.AutoRefreshEnabled;
        _refreshSeconds = Settings.AutoRefreshSeconds;
        _onlySinceRestart = Settings.OnlySinceRestart;
        reload = _onlySinceRestart ? ReloadOption.SeitLetztemNeuladen : ReloadOption.SeitStartDerAnwendung;
        await LoadLogs();
        StartTimer();
    }

    private void HandleTimer(double seconds)
    {
        _refreshSeconds = (int)seconds;
        if(_refreshSeconds <= 0)
        {
            _autoRefresh = false;
        }
        else
        {
            _autoRefresh = true;
        }
        StartTimer();
    }
    
    private async Task LoadLogs()
    {
        _isLoading = true;
        StateHasChanged();
        var since = reload == ReloadOption.AlleLogs ? DateTime.MinValue  : _onlySinceRestart ? _lastShopRestart : _appStartTime;
        var logs = await Task.Run(() => _logService?.GetLogs(since, LogLevel.All) ?? Enumerable.Empty<LogEntry>());
        _logs = logs.ToList();
        _displayLogs = _logs
            .Where(l => _selectedLevels.Contains(l.Level))
            .ToList();
        _isLoading = false;
        StateHasChanged();
    }

    private async Task LoadLogs(ReloadOption option)
    {
        reload = option;
        await LoadLogs();
    }

    private void StartTimer()
    {
        _timer?.Stop();
        _timer?.Dispose();
        _timer = null;

        if (_autoRefresh && _refreshSeconds > 0)
        {
            _timer = new System.Timers.Timer(_refreshSeconds * 1000);
            _timer.Elapsed += async (_, _) =>
            {
                await InvokeAsync(async () =>
                {
                    await LoadLogs();
                    StateHasChanged();
                });
            };
            _timer.AutoReset = true;
            _timer.Start();
        }
    }

    private void ToggleAutoRefresh(bool value)
    {
        _autoRefresh = value;
        StartTimer();
    }

    private void IntervalChanged(int value)
    {
        if (value <= 0) return;
        _refreshSeconds = value;
        StartTimer();
    }

    private async Task ShowLogDetails(TableRowClickEventArgs<LogEntry> args)
    {
        var parameters = new DialogParameters<LogEntryDialog> { {x => x.Entry, args.Item} };
        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Large,
            FullWidth = true,
            BackdropClick = true,
        };
        await DialogService.ShowAsync<LogEntryDialog>("", parameters, options);
    }

    private Color GetColor(LogLevel level) => level switch
    {
        LogLevel.Information => Color.Info,
        LogLevel.Warning => Color.Warning,
        LogLevel.Error => Color.Error,
        LogLevel.Critical => Color.Error,
        _ => Color.Default
    };

    private Color GetColor() => manager.Sites[Settings.IisAppName].State switch
    {
        ObjectState.Started => Color.Success,
        ObjectState.Starting => Color.Warning,
        ObjectState.Stopped => Color.Error,
        ObjectState.Stopping => Color.Warning,
        _ => Color.Default
    };

    private string GetIcon(LogLevel level) => level switch
