@using Microsoft.AspNetCore.Components
@using Toolbox.Data.Models.Logs

<MudDialog MaxWidth="MaxWidth.Small">
    <TitleContent>
        <MudText Typo="Typo.h5">@Entry.Level - @Entry.Time</MudText>
    </TitleContent>
    <DialogContent>
        @if (Entry.ParsedMessage.IsValid)
        {
            <MudStack>
                <div class="row g-0">
                    <div class="d-flex align-items-center justify-content-center mb-0 col-auto">
                        <MudText Typo="Typo.h6">Metadata:</MudText>
                    </div>
                    <div class="d-flex align-items-center ml-3 col">
                        <MudToggleIconButton @bind-Toggled="_expanded" Icon="@Icons.Material.Filled.KeyboardArrowDown" ToggledIcon="@Icons.Material.Filled.KeyboardArrowUp"></MudToggleIconButton>
                    </div>
                </div>
                <MudCollapse Expanded="_expanded">
                    <pre>@Entry.ParsedMessage.Metadata</pre>
                </MudCollapse>
            </MudStack>
            <MudText Typo="Typo.h6" Class="mb-2">Message:</MudText>
            <MudText Class="mt-2 text-break text-wrap" Style="white-space: pre-wrap;">@FormatMessage(Entry.ParsedMessage.Message)</MudText>
        }
        else
        {
            <MudText Class="mt-2" Style="white-space: pre-wrap;">@FormatMessage(Entry.Message)</MudText>
        }
       
    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Primary" OnClick="Close">Schlie√üen</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public LogEntry Entry { get; set; } = default!;

    void Close() => MudDialog.Close();
    
    bool _expanded = true;

    private static MarkupString FormatMessage(string? message)
    {
        if (string.IsNullOrEmpty(message))
        {
            return new MarkupString();
        }

        // Convert escaped newline sequences to actual line breaks and render them as <br>.
        var normalized = message
            .Replace("\\r\\n", "\n")
            .Replace("\\n", "\n")
            .Replace("\\r", "\n");

        var encoded = System.Net.WebUtility.HtmlEncode(normalized);
        var html = encoded
            .Replace("\r\n", "<br/>")
            .Replace("\n", "<br/>");

        return (MarkupString)html;
    }
}
