@using Toolbox.Components.Dialogs
@using Toolbox.Data.Models
@using System.Linq
@inject Toolbox.Services.GitRepoService Git
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudDialog>
    <DialogContent>
        <MudText Typo="Typo.h6" Class="mb-4">@Title</MudText>
        @if (AllowMultiple)
        {
            @for (var i = 0; i < _gitUrls.Count; i++)
            {
                var index = i;
                <div class="d-flex align-items-center mb-2">
                    <MudTextField @bind-Value="_gitUrls[index]"
                                  Label="@($"Git URL {index + 1}")"
                                  Variant="Variant.Filled"
                                  Class="flex-grow-1 me-2" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                   Color="Color.Default"
                                   Disabled="_gitUrls.Count == 1"
                                   OnClick="@(() => RemoveGitUrl(index))" />
                </div>
            }
            <MudButton Variant="Variant.Text"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Add"
                       OnClick="AddGitUrl">
                Weitere URL
            </MudButton>
        }
        else
        {
            <MudTextField @bind-Value="_gitUrl" Label="Git URL" Variant="Variant.Filled" Class="mb-2" />
        }

        <MudSelect T="string"
                   Label="Zielpfad"
                   Variant="Variant.Filled"
                   @bind-Value="_selectedDestination"
                   Dense="true"
                   Class="mb-3">
            @if (DestinationOptions?.Any() == true)
            {
                @foreach (var opt in DestinationOptions)
                {
                    <MudSelectItem Value="@opt">@opt</MudSelectItem>
                }
            }
            else
            {
                <MudSelectItem Value="@DestinationRoot">@DestinationRoot</MudSelectItem>
            }
        </MudSelect>

        <MudText Class="mt-2 mb-1" Typo="Typo.subtitle2">Aktionen nach dem Klonen</MudText>
        <div class="row d-flex align-items-center justify-content-center">
            @if (_options.Count == 0)
            {
                <div class="col-12 d-flex align-items-center justify-content-center w-100">
                    <MudText Class="mb-2" Typo="Typo.caption">Keine zus√§tzlichen Aktionen.</MudText>
                </div>
            }
            else
            {
                @foreach (var opt in _options)
                {                
                    <div class="col-6 d-flex align-items-center justify-content-center">
                        <MudCheckBox @bind-Value="opt.Selected" Color="Color.Primary" Label="@opt.Label" />
                    </div>
                }
            }
        </div>
    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Primary" Disabled="_busy" OnClick="Clone">@(_busy ? "Klonen..." : "Klonen")</MudButton>
        <MudButton Color="Color.Default" Disabled="_busy" OnClick="Cancel">Abbrechen</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public string DestinationRoot { get; set; } = string.Empty;
    [Parameter] public List<string> DestinationOptions { get; set; } = new();
    [Parameter] public List<RepoAction> Actions { get; set; } = new();
    [Parameter] public string Title { get; set; } = "Repository klonen";
    [Parameter] public bool AllowMultiple { get; set; }

    private readonly List<ActionOption> _options = new();
    private string _gitUrl = string.Empty;
    private readonly List<string> _gitUrls = new() { string.Empty };
    private string _selectedDestination = string.Empty;
    private bool _busy;

    protected override void OnInitialized()
    {
        var roots = (DestinationOptions ?? new()).Where(d => !string.IsNullOrWhiteSpace(d)).Select(d => d.Trim()).Distinct(StringComparer.OrdinalIgnoreCase).ToList();
        if (!string.IsNullOrWhiteSpace(DestinationRoot) && !roots.Contains(DestinationRoot))
        {
            roots.Insert(0, DestinationRoot);
        }
        DestinationOptions = roots;
        _selectedDestination = DestinationRoot ?? string.Empty;
        if (string.IsNullOrWhiteSpace(_selectedDestination))
        {
            _selectedDestination = DestinationOptions.FirstOrDefault() ?? string.Empty;
        }

        foreach (var a in Actions ?? new())
        {
            _options.Add(new ActionOption
            {
                Label = a.Label,
                Selected = false,
                ExecuteAsync = a.ExecuteAsync,
                ExecuteWithProgressAsync = a.ExecuteWithProgressAsync
            });
        }
    }

    private void AddGitUrl()
    {
        _gitUrls.Add(string.Empty);
    }

    private void RemoveGitUrl(int index)
    {
        if (index < 0 || index >= _gitUrls.Count)
        {
            return;
        }

        if (_gitUrls.Count == 1)
        {
            _gitUrls[0] = string.Empty;
            return;
        }

        _gitUrls.RemoveAt(index);
    }

    private async Task Clone()
    {
        List<string> urls;

        if (AllowMultiple)
        {
            urls = _gitUrls
                .Select(u => u?.Trim())
                .Where(u => !string.IsNullOrWhiteSpace(u))
                .Distinct(StringComparer.OrdinalIgnoreCase)
                .ToList();

            if (urls.Count == 0)
            {
                Snackbar.Add("Bitte mindestens eine Git URL angeben.", Severity.Warning);
                return;
            }
        }
        else
        {
            if (string.IsNullOrWhiteSpace(_gitUrl))
            {
                Snackbar.Add("Bitte eine Git URL angeben.", Severity.Warning);
                return;
            }

            urls = new List<string> { _gitUrl.Trim() };
        }

        if (string.IsNullOrWhiteSpace(_selectedDestination))
        {
            Snackbar.Add("Kein Zielordner angegeben.", Severity.Error);
            return;
        }

        _busy = true;
        StateHasChanged();
        try
        {
            var selected = _options.Where(o => o.Selected).ToList();

            var autoClose = AllowMultiple && urls.Count > 1;

            foreach (var url in urls)
            {
                var itemName = autoClose ? Git.GetRepoName(url) : string.Empty;
                if (string.IsNullOrWhiteSpace(itemName))
                {
                    itemName = url;
                }

                var parameters = new DialogParameters<CloneActionsDialog>
                {
                    { x => x.GitUrl, url },
                    { x => x.DestinationRoot, _selectedDestination },
                    { x => x.Actions, selected },
                    { x => x.AutoCloseOnSuccess, autoClose },
                    { x => x.ItemName, itemName }
                };

                var opts = new DialogOptions
                {
                    MaxWidth = MaxWidth.Large,
                    FullWidth = true,
                    CloseButton = true,
                    BackdropClick = true
                };

                var dlg = await DialogService.ShowAsync<CloneActionsDialog>("Aktionen nach dem Klonen", parameters, opts);
                await dlg.Result;
            }

            MudDialog.Close(DialogResult.Ok(true));
        }
        finally
        {
            _busy = false;
            StateHasChanged();
        }
    }

    private void Cancel() => MudDialog.Cancel();
}
