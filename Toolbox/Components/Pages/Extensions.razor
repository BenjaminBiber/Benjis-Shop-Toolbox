@page "/extensions"
@using System.Diagnostics
@using System.IO
@using Toolbox.Components.Dialogs
@using Toolbox.Data.Models
@using Toolbox.Data.Services
@using Toolbox.ExtensionMethods
@inject NotificationService NotificationService
@inject ExtensionsService ExtensionsService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject Toolbox.Services.SettingsService SettingsService
@inject SolutionOpener SolutionOpener
@inject IisService IisService
@inject ShopSystemConfigService ShopSystemConfigService

@if (false)
{
    <div class="d-flex flex-column align-items-center justify-content-center my-6">
        <MudAlert Icon="@Icons.Material.Filled.Warning"
                  Variant="Variant.Filled"
                  Severity="Severity.Warning">
            Kein Shop ausgewählt
        </MudAlert>
        @if (Settings.ShopSettingsList.Any())
        {
            <div class="mt-4" style="min-width:300px;">
                <MudSelect Variant="Variant.Outlined" Value="_selectedShopPath" ValueChanged="ChangeSelectedShop" T="string">
                    @foreach (var shopPaths in Settings.ShopSettingsList)
                    {
                        <MudSelectItem Value="@shopPaths.ShopYamlPath">@GetShopDisplayName(shopPaths)</MudSelectItem>
                    }
                </MudSelect>
            </div>
        }
    </div>
}

@if (Settings.ShopSettingsList.Any())
{        
    <div class="row p-4">
        <MudText Typo="Typo.h5">Extensions</MudText>   
        <div class="col-4">
            <MudSelect Variant="Variant.Outlined" Value="_selectedShopPath" ValueChanged="ChangeSelectedShop" T="string">
                @foreach (var shopPaths in Settings.ShopSettingsList)
                {
                    <MudSelectItem Value="@shopPaths.ShopYamlPath">@GetShopDisplayName(shopPaths)</MudSelectItem>
                }
            </MudSelect>
        </div>
        <div class="col-7">
            <MudTextField Variant="Variant.Outlined"
                          Value="_searchText"
                          ValueChanged="(string s) => SearchChanged(s)"
                          Immediate="true"
                          Placeholder="Suche..."
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          IconSize="Size.Medium"
                          Class="mt-0" />
        </div>
        <div class="col-1 d-flex align-items-center justify-content-center">
            <MudTooltip Text="Extension klonen">
                <MudIconButton Icon="@Icons.Material.Filled.Add" Color="Color.Primary" OnClick="OpenCloneDialog" />
            </MudTooltip>
        </div>
    </div>
}

@if (_groupedExtensions != null)
{
    <div class="row g-0 px-3 g- d-flex align-items-start justify-content-center gap-3">
        <MudPaper Class="col-12 mx-3 p-4">
            <MudTable Loading="_isLoading"
                      @ref="_table"
                      Filter="new Func<ExtensionInfo,bool>(FilterThemes)"
                      Elevation="0"
                      GroupHeaderStyle="background-color:var(--mud-palette-background-gray)"
                      GroupBy="_groupDefinition"
                      Items="_groupedExtensions"
                      Hover="true"
                      Dense="true">
                <HeaderContent>
                    <MudTh>Name</MudTh>
                    <MudTh>Install Projekt</MudTh>
                    <MudTh>Data Projekt</MudTh>
                    <MudTh>Shop Projekt</MudTh>
                    <MudTh>ThemeV4</MudTh>
                    <MudTh>Aktionen</MudTh>
                    <MudTh>Öffnen</MudTh>
                </HeaderContent>
                <GroupHeaderTemplate>
                    <MudTh Class="mud-table-cell-custom-group" colspan="7">
                        <MudText Class="fw-bold" Typo="Typo.h6">@($"{context.Key}")</MudText>
                    </MudTh>
                </GroupHeaderTemplate>
                <RowTemplate>
                    <MudTd DataLabel="Name">@context.Name</MudTd>
                    <MudTd DataLabel="Install Projekt">
                        @if (context.HasInstallProject)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" />
                        }
                    </MudTd>
                    <MudTd DataLabel="Data Projekt">
                        @if (context.HasDataProject)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Warning" />
                        }
                    </MudTd>
                    <MudTd DataLabel="Shop Projekt">
                        @if (context.HasShopProject)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Info" />
                        }
                    </MudTd>
                    <MudTd DataLabel="ThemeV4">
                        @if (context.HasThemeV4)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Primary" />
                        }
                    </MudTd>
                    <MudTd DataLabel="Aktionen">
                        <MudMenu Icon="@Icons.Material.Filled.Build" Color="Color.Error">
                            <MudMenuItem Label="Extension Builden"
                                         OnClick="@(() => BuildExtensionFromMenuAsync(context))" />
                            <MudMenuItem Label="Extension Datenbank Installieren"
                                         OnClick="@(() => InstallExtension(context))" />
                        </MudMenu>
                    </MudTd>
                    <MudTd DataLabel="Öffnen">
                        <MudTooltip Text="Öffnen in">
                            <MudMenu Icon="@Icons.Material.Filled.OpenInNew">
                                <MudMenuItem OnClick="@(() => OpenDirectoryInExplorer(context.Path))"
                                             Label="Explorer" />
                                <MudMenuItem OnClick="@(() => OpenSolution(context))"
                                             Label="Rider" />
                            </MudMenu>
                        </MudTooltip>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </MudPaper>
    </div>
}
else
{
    <div class="d-flex justify-content-center my-3">
        <MudAlert Icon="@Icons.Material.Filled.Info"
                  Variant="Variant.Filled"
                  Severity="Severity.Info">
            Keine Extensions für die aktuell ausgewählte Seite vorhanden
        </MudAlert>
    </div>
}

@code {
    private List<ExtensionInfo> _groupedExtensions;
    private bool _isLoading;
    private ToolboxSettings Settings => SettingsService.Settings;
    private string _selectedShopPath = string.Empty;
    private ShopSetting? SelectedShopSetting =>
        Settings.ShopSettingsList.FirstOrDefault(s =>
            string.Equals(s.ShopYamlPath, _selectedShopPath, StringComparison.OrdinalIgnoreCase))
        ?? Settings.GetShopSettingForCurrentSite();
    private MudTable<ExtensionInfo> _table = null!;
    private string _searchText = string.Empty;

    private TableGroupDefinition<ExtensionInfo> _groupDefinition = new()
    {
        GroupName = "Group",
        Indentation = true,
        Expandable = true,
        Selector = e => e.GetCustomerName(),
        IsInitiallyExpanded = false
    };

    protected override async Task OnInitializedAsync()
    {
        var current = Settings.GetShopSettingForCurrentSite();
        _selectedShopPath = current?.ShopYamlPath ?? string.Empty;

        await EnsureShopSelectedAsync();

        await LoadAsync();
    }

    private async Task EnsureShopSelectedAsync()
    {
        if (SelectedShopSetting != null || !Settings.ShopSettingsList.Any())
            return;

        var parameters = new DialogParameters<SelectShopDialog>
        {
            { x => x.Shops, Settings.ShopSettingsList },
            { x => x.SelectedShopPath, _selectedShopPath }
        };

        var dlg = await DialogService.ShowAsync<SelectShopDialog>("Shop auswählen", parameters);
        var result = await dlg.Result;

        if (!result.Canceled && result.Data is string path && !string.IsNullOrWhiteSpace(path))
        {
            await ChangeSelectedShop(path);
        }
    }

    private async Task SearchChanged(string? searchValue)
    {
        _searchText = searchValue ?? string.Empty;

        var groups = _groupedExtensions
            .GroupBy(t => t.GetCustomerName() ?? string.Empty)
            .ToList();

        bool MatchesSearch(ExtensionInfo i) =>
            string.IsNullOrWhiteSpace(_searchText)
            || (i.Name?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false)
            || (i.GetCustomerName()?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false);

        var visibleGroups = groups
            .Where(g => g.Any(MatchesSearch))
            .ToList();

        if (visibleGroups.Count == 1)
        {
            _table.ExpandAllGroups();

            var firstMatch = visibleGroups[0]
                                 .FirstOrDefault(MatchesSearch)
                             ?? visibleGroups[0].FirstOrDefault();

            if (firstMatch is not null)
                await _table.ScrollToItemAsync(firstMatch);
        }
        else
        {
            _table.CollapseAllGroups();
        }
    }

    private bool FilterThemes(ExtensionInfo info)
    {
        return info.Name.Contains(_searchText.Trim(), StringComparison.OrdinalIgnoreCase);
    }

    public static void OpenDirectoryInExplorer(string path)
    {
        if (Directory.Exists(path))
        {
            Process.Start("explorer.exe", path);
        }
        else
        {
            Console.WriteLine("Ordner existiert nicht: " + path);
        }
    }

    private void OpenSolution(ExtensionInfo info)
    {
        Snackbar.Add($"{info.Name} wird in Rider geöffnet...", Severity.Info);
        SolutionOpener.OpenSolutionInRider(info.Path);
    }

    private async Task ChangeSelectedShop(string shopPath)
    {
        _selectedShopPath = shopPath ?? string.Empty;
        var selected = Settings.ShopSettingsList.FirstOrDefault(s =>
            string.Equals(s.ShopYamlPath, _selectedShopPath, StringComparison.OrdinalIgnoreCase));
        var siteName = selected != null ? IisService.GetSiteNameById(selected.SiteId) : null;
        if (!string.IsNullOrEmpty(siteName))
        {
            Settings.IisAppName = siteName;
            SettingsService.SaveSettings();
        }

        try
        {
            var shopRoot = selected != null ? Path.GetDirectoryName(selected.ShopYamlPath) : null;
            if (!string.IsNullOrWhiteSpace(shopRoot))
            {
                var root = Settings.GeneralFolderPath;
                var ok = await ShopSystemConfigService.SetShopPathUsingRootAsync(root, shopRoot!);
                if (!ok)
                {
                    Snackbar.Add("shopsystem.json im Allgemeinen Ordner nicht gefunden.", Severity.Warning);
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fehler beim Aktualisieren der shopsystem.json: {ex.Message}", Severity.Warning);
        }

        await LoadAsync();
    }

    private string GetShopDisplayName(ShopSetting s)
    {
        var name = IisService.GetSiteNameById(s.SiteId);
        if (!string.IsNullOrWhiteSpace(name)) return name;

        try
        {
            var yamlPath = s.ShopYamlPath ?? string.Empty;
            var dir = Path.GetDirectoryName(yamlPath) ?? string.Empty;
            if (string.IsNullOrWhiteSpace(dir)) return yamlPath;

            var segments = dir.Split(new[]
                {
                    Path.DirectorySeparatorChar,
                    Path.AltDirectorySeparatorChar
                },
                StringSplitOptions.RemoveEmptyEntries);

            string? candidate = null;

            var idxCustomerRoot = Array.FindIndex(segments,
                p => p.Equals("KundenShops", StringComparison.OrdinalIgnoreCase));
            if (idxCustomerRoot >= 0 && idxCustomerRoot + 1 < segments.Length)
            {
                candidate = segments[idxCustomerRoot + 1];
            }

            if (candidate == null)
            {
                var idxShopSystem = Array.FindIndex(segments,
                    p => p.Equals("Shopsystem", StringComparison.OrdinalIgnoreCase));
                if (idxShopSystem > 0)
                {
                    candidate = segments[idxShopSystem - 1];
                }
            }

            if (candidate == null)
            {
                for (var i = segments.Length - 1; i >= 0; i--)
                {
                    var seg = segments[i];
                    if (!seg.Equals("Shop", StringComparison.OrdinalIgnoreCase))
                    {
                        candidate = seg;
                        break;
                    }
                }
            }

            if (!string.IsNullOrWhiteSpace(candidate)) return candidate;

            var baseName = Path.GetFileName(dir);
            return string.IsNullOrWhiteSpace(baseName) ? dir : baseName;
        }
        catch
        {
            return s.ShopYamlPath;
        }
    }

    private async Task LoadAsync()
    {
        _isLoading = true;
        StateHasChanged();

        var setting = SelectedShopSetting;
        if (setting == null)
        {
            _groupedExtensions = null;
            _isLoading = false;
            StateHasChanged();
            return;
        }

        _groupedExtensions = ExtensionsService.GetExtensions().ToList();
        _isLoading = false;
        StateHasChanged();
    }

    private async Task OpenCloneDialog()
    {
        var setting = SelectedShopSetting;
        if (setting == null)
        {
            return;
        }

        var actions = new List<RepoAction>
        {
            new RepoAction
            {
                Label = "Nach dem Klonen Builden",
                ExecuteWithProgressAsync = async (dir, output, error) =>
                {
                    var name = Path.GetFileName(dir);
                    if (string.IsNullOrWhiteSpace(name))
                        name = dir;
                    
                    output?.Report($"Build für {name} gestartet...\n");

                    var ok = await ExtensionsService.BuildAsync(dir, output, error);

                    if (!ok)
                    {
                        error?.Report($"Build für {name} fehlgeschlagen.\n");
                    }

                    return ok;
                }
            },
            new RepoAction
            {
                Label = "Nach dem Klonen die Datenbank installieren",
                ExecuteWithProgressAsync = async (dir, output, error) =>
                {
                    var info = new ExtensionInfo
                    {
                        Name = Path.GetFileName(dir),
                        Path = dir,
                        HasSolution = Directory.GetFiles(dir, "*.sln", SearchOption.AllDirectories).Length > 0,
                        HasProjects = Directory.GetFiles(dir, "*.csproj", SearchOption.AllDirectories).Length > 0,
                        HasShopProject = Directory.GetDirectories(dir, "*.Shop", SearchOption.AllDirectories).Length > 0,
                        HasDataProject = Directory.GetDirectories(dir, "*.Data", SearchOption.AllDirectories).Length > 0,
                        HasInstallProject = Directory.GetDirectories(dir, "*.Install", SearchOption.AllDirectories).Length > 0,
                        HasThemeV4 = Directory.GetDirectories(dir, "4SELLERS_Responsive_4", SearchOption.AllDirectories).Length > 0
                    };

                    var conn = SelectedShopSetting?.GetConnection();
                    if (conn == null)
                    {
                        error?.Report("Keine Datenbankverbindung (shop.yaml) gefunden.\n");
                        Snackbar.Add("Keine Datenbankverbindung (shop.yaml) gefunden.", Severity.Warning);
                        return false;
                    }

                    var title = $"Installation: {info.Name}";
                    output?.Report($"{title} gestartet...\n");

                    var (ok, log) = await info.InstallWithLogAsync(conn, output, error);

                    if (!ok)
                    {
                        var msg = string.IsNullOrWhiteSpace(log)
                            ? "Installation fehlgeschlagen."
                            : log;
                        error?.Report(msg + "\n");
                        Snackbar.Add(msg, Severity.Error);
                    }

                    return ok;
                }
            },
            new RepoAction
            {
                Label = "Nach dem Klonen in Rider öffnen",
                ExecuteAsync = dir =>
                {
                    OpenDirectoryInExplorer(dir);
                    SolutionOpener.OpenSolutionInRider(dir);
                    return Task.FromResult(true);
                }
            }
        };

        var result = await DialogService.ShowCloneDialog(
            "Extension-Repository klonen",
            Settings.ExtensionsRepositoryPath,
            actions, true);

        if (!result)
        {
            await LoadAsync();
        }
    }

    private async Task<bool> InstallExtension(string dir)
    {
        var info = new ExtensionInfo
        {
            Name = Path.GetFileName(dir),
            Path = dir,
            HasSolution = Directory.GetFiles(dir, "*.sln", SearchOption.AllDirectories).Length > 0,
            HasProjects = Directory.GetFiles(dir, "*.csproj", SearchOption.AllDirectories).Length > 0,
            HasShopProject = Directory.GetDirectories(dir, "*.Shop", SearchOption.AllDirectories).Length > 0,
            HasDataProject = Directory.GetDirectories(dir, "*.Data", SearchOption.AllDirectories).Length > 0,
            HasInstallProject = Directory.GetDirectories(dir, "*.Install", SearchOption.AllDirectories).Length > 0,
            HasThemeV4 = Directory.GetDirectories(dir, "4SELLERS_Responsive_4", SearchOption.AllDirectories).Length > 0
        };

        return await InstallExtensionCoreAsync(info);
    }

    private async Task InstallExtension(ExtensionInfo info) =>
        await InstallExtensionCoreAsync(info);

    private async Task<bool> InstallExtensionCoreAsync(ExtensionInfo info)
    {
        try
        {
            var conn = SelectedShopSetting?.GetConnection();
            if (conn == null)
            {
                Snackbar.Add("Keine Datenbankverbindung (shop.yaml) gefunden.", Severity.Warning);
                return false;
            }

            var title = $"Installation: {info.Name}";
            var logBuffer = new LogBuffer();
            logBuffer.AppendLine($"{title} gestartet...");

            var parameters = new DialogParameters<LogDialog>
            {
                { x => x.Title, title },
                { x => x.LogBuffer, logBuffer }
            };

            await DialogService.ShowAsync<LogDialog>(
                "Installationsprotokoll",
                parameters,
                new DialogOptions { MaxWidth = MaxWidth.Large, FullWidth = true });

            var outputProgress = new Progress<string>(s => logBuffer.Append(s));
            var errorProgress = new Progress<string>(s => logBuffer.Append(s));

            var (ok, log) = await info.InstallWithLogAsync(conn, outputProgress, errorProgress);

            if (!ok)
            {
                Snackbar.Add(string.IsNullOrWhiteSpace(log)
                    ? "Installation fehlgeschlagen."
                    : log, Severity.Error);
            }

            return ok;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Installationsfehler: {ex.Message}", Severity.Error);
            return false;
        }
    }

    private async Task BuildExtensionFromMenuAsync(ExtensionInfo info) =>
        await BuildExtensionWithDialogAsync(info.Path, info.Name);

    private async Task<bool> BuildExtensionWithDialogAsync(string directory, string extensionName)
    {
        try
        {
            var logBuffer = new LogBuffer();
            logBuffer.AppendLine($"Build für {extensionName} gestartet...");

            var parameters = new DialogParameters<LogDialog>
            {
                { x => x.Title, $"Build: {extensionName}" },
                { x => x.LogBuffer, logBuffer }
            };

            await DialogService.ShowAsync<LogDialog>(
                "Build-Protokoll",
                parameters,
                new DialogOptions { MaxWidth = MaxWidth.Large, FullWidth = true });

            var outputProgress = new Progress<string>(s => logBuffer.Append(s));
            var errorProgress = new Progress<string>(s => logBuffer.Append(s));

            var ok = await ExtensionsService.BuildAsync(directory, outputProgress, errorProgress);

            if (!ok)
            {
                Snackbar.Add($"Build für {extensionName} fehlgeschlagen.", Severity.Error);
            }

            return ok;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Build-Fehler: {ex.Message}", Severity.Error);
            return false;
        }
    }
}
