@page "/themes"
@using System.Diagnostics
@using System.IO
@using Toolbox.Data.Models
@using Toolbox.Data.Services
@using Toolbox.Components.Dialogs
@using Microsoft.Web.Administration
@using Toolbox.Services
@using MudBlazor
@inject ThemeLinkService ThemeService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject Toolbox.Services.SettingsService SettingsService
@inject SolutionOpener SolutionOpener
@inject IisService IisService

@if (false)
{
    <div class="d-flex flex-column align-items-center justify-content-center my-6">
        <MudAlert Icon="@Icons.Material.Filled.Warning"
                  Variant="Variant.Filled"
                  Severity="Severity.Warning">
            Kein Shop ausgewählt
        </MudAlert>
        @if (Settings.ShopSettingsList.Any())
        {
            <div class="mt-4" style="min-width:300px;">
                <MudSelect Variant="Variant.Outlined" Value="_selectedShopPath" ValueChanged="ChangeSelectedShop" T="string">
                    @foreach (var shopPaths in Settings.ShopSettingsList)
                    {
                        <MudSelectItem Value="@shopPaths.ShopYamlPath">@GetShopDisplayName(shopPaths)</MudSelectItem>
                    }
                </MudSelect>
            </div>
        }
    </div>
}

@if (Settings.ShopSettingsList.Any())
{        
    <div class="row p-4">
        <MudText Typo="Typo.h5">Themes</MudText>   
        <div class="col-4">
            <MudSelect Variant="Variant.Outlined" Value="_selectedShopPath" ValueChanged="ChangeSelectedShop" T="string">
                @foreach (var shopPaths in Settings.ShopSettingsList)
                {
                    <MudSelectItem Value="@shopPaths.ShopYamlPath">@GetShopDisplayName(shopPaths)</MudSelectItem>
                }
            </MudSelect>
        </div>
        <div class="col-7">
            <MudTextField Variant="Variant.Outlined" Value="_searchText" ValueChanged="(string s) => SearchChanged(s)" Immediate="true" Placeholder="Suche..." Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
        </div>
        <div class="col-1 d-flex align-items-center justify-content-center">
            <MudTooltip Text="Neues Theme hinzufügen">
                <MudIconButton Icon="@Icons.Material.Filled.Add" Color="Color.Primary" OnClick="OpenCloneDialog"/>
            </MudTooltip>
        </div>
    </div>
}

@if (_groupedThemes != null)
{
    <div class="row g-0 px-3 g- d-flex align-items-start justify-content-center gap-3">
      <MudPaper Class="col-12 mx-3 p-4">
            <MudTable Loading="_isLoading" @ref="_table" Filter="new Func<ThemeInfo,bool>(FilterThemes)" Elevation="0" GroupHeaderStyle="background-color:var(--mud-palette-background-gray)" GroupBy="_groupDefinition" Items="_groupedThemes" Hover="true" Dense="true">
                <HeaderContent>
                <MudTh>Name</MudTh>
                <MudTh>Virtuelles Verzeichnis</MudTh>
                <MudTh>Wird im Shop verwendet</MudTh>
                <MudTh>öffnen</MudTh>
            </HeaderContent>
            <GroupHeaderTemplate>
                <MudTh Class="mud-table-cell-custom-group" colspan="5">
                    <div class="d-flex align-items-center">
                        <MudText Class="fw-bold me-auto" Typo="Typo.h6">@($"{context.Key}")</MudText>
                        @{
                            var groupKey = context.Key?.ToString() ?? string.Empty;
                            var isPinned = _pinnedThemeGroups.Contains(groupKey);
                        }
                        <MudIconButton Icon="@(isPinned ? Icons.Material.Filled.PushPin : Icons.Material.Outlined.PushPin)"
                                       Color="@(isPinned ? Color.Primary : Color.Default)"
                                       Size="Size.Small"
                                       OnClick="@(() => TogglePinnedThemeGroup(groupKey))" />
                    </div>
                </MudTh>
            </GroupHeaderTemplate>
            <RowTemplate>
                <MudTd DataLabel="Name">@context.Name</MudTd>
                <MudTd>
                    @if (context.LinkExists)
                    {
                        <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Error" OnClick="@(async () => await Remove(context))">Entfernen</MudButton>
                    }
                    else
                    {
                        <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Primary" OnClick="@(async () => await Create(context))">Anlegen</MudButton>
                    }
                </MudTd>
                <MudTd>
                    <MudCheckBox Disabled="context.IsThemeOverwrite || !context.LinkExists" Value="context.IsThemeOverwrite" ValueChanged="@(async (bool t) => await ThemeOverwriteChanged(context))" Color="Color.Primary"/>
                </MudTd>
                <MudTd>
                    <MudTooltip Text="Öffnen in">
                        <MudMenu Icon="@Icons.Material.Filled.OpenInNew">
                            <MudMenuItem OnClick="@(() => OpenDirectoryInExplorer(context.Path))" Label="Explorer"/>
                            <MudMenuItem OnClick="@(() => OpenSolution(context))" Label="Rider"/>
                        </MudMenu>
                    </MudTooltip>
                </MudTd>
            </RowTemplate>
        </MudTable>
        </MudPaper>
    </div>
}
else
{
    <div class="d-flex justify-content-center my-3">
        <MudAlert Icon="@Icons.Material.Filled.Info" Variant="Variant.Filled" Severity="Severity.Info">Keine Themes für die aktuell ausgewählte Seite vorhanden</MudAlert>
    </div>    
}

@code {
    private List<ThemeInfo> _groupedThemes;
    private bool _isLoading;
    private ToolboxSettings Settings => SettingsService.Settings;
    private string _selectedShopPath = string.Empty;
    private ShopSetting? SelectedShopSetting =>
        Settings.ShopSettingsList.FirstOrDefault(s => string.Equals(s.ShopYamlPath, _selectedShopPath, StringComparison.OrdinalIgnoreCase))
        ?? Settings.GetShopSettingForCurrentSite();
    private MudTable<ThemeInfo> _table = null!;
    private string _searchText = string.Empty;
    private readonly HashSet<string> _pinnedThemeGroups = new(StringComparer.OrdinalIgnoreCase);
    
    private TableGroupDefinition<ThemeInfo> _groupDefinition = new()
    {
        GroupName = "Group",
        Indentation = true,
        Expandable = true,
        Selector = (e) => e.Repo,
        IsInitiallyExpanded = false
    };
    
    protected override async Task OnInitializedAsync()
    {
        var current = Settings.GetShopSettingForCurrentSite();
        _selectedShopPath = current?.ShopYamlPath ?? string.Empty;

        LoadPinnedThemeGroups();

        await EnsureShopSelectedAsync();

        await LoadAsync();
    }

    private async Task EnsureShopSelectedAsync()
    {
        if (SelectedShopSetting != null || !Settings.ShopSettingsList.Any())
            return;

        var parameters = new DialogParameters<SelectShopDialog>
        {
            { x => x.Shops, Settings.ShopSettingsList },
            { x => x.SelectedShopPath, _selectedShopPath }
        };

        var dlg = await DialogService.ShowAsync<SelectShopDialog>("Shop auswählen", parameters);
        var result = await dlg.Result;

        if (!result.Canceled && result.Data is string path && !string.IsNullOrWhiteSpace(path))
        {
            await ChangeSelectedShop(path);
        }
    }

    private async Task SearchChanged(string? searchValue)
    {
        _searchText = searchValue ?? string.Empty;

        var groups = _groupedThemes
            .GroupBy(t => t.ThemeFolder ?? string.Empty)
            .ToList();

        bool MatchesSearch(ThemeInfo i) =>
            string.IsNullOrWhiteSpace(_searchText)
            || (i.Name?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false)
            || (i.ThemeFolder?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false);

        var visibleGroups = groups
            .Where(g => g.Any(MatchesSearch))
            .ToList();

        if (visibleGroups.Count == 1)
        {
            _table.ExpandAllGroups();

            var firstMatch = visibleGroups[0]
                                 .FirstOrDefault(i => MatchesSearch(i)) 
                             ?? visibleGroups[0].FirstOrDefault();

            if (firstMatch is not null)
                await _table.ScrollToItemAsync(firstMatch);
        }
        else
        {
            _table.CollapseAllGroups();
        }
    }
    
    private bool FilterThemes(ThemeInfo info)
    {
        return info.Name.Contains(_searchText.Trim(), StringComparison.OrdinalIgnoreCase);
    }
    
    public static void OpenDirectoryInExplorer(string path)
    {
        if (Directory.Exists(path))
        {
            Process.Start("explorer.exe", path);
        }
        else
        {
            Console.WriteLine("Ordner existiert nicht: " + path);
        }
    }

    private void OpenSolution(ThemeInfo info)
    {
        Snackbar.Add($"{info.Name} wird in Rider geöffnet...", Severity.Info);
        SolutionOpener.OpenSolutionInRider(info.ThemeFolder);
    }

    private async Task ChangeSelectedShop(string shopPath)
    {
        _selectedShopPath = shopPath ?? string.Empty;
        var selected = Settings.ShopSettingsList.FirstOrDefault(s => string.Equals(s.ShopYamlPath, _selectedShopPath, StringComparison.OrdinalIgnoreCase));
        var siteName = (selected != null) ? IisService.GetSiteNameById(selected.SiteId) : null;
        if (!string.IsNullOrEmpty(siteName))
        {
            Settings.IisAppName = siteName;
            SettingsService.SaveSettings();
        }
        await LoadAsync();
    }
    
    private async Task LoadAsync()
    {
        _isLoading = true;
        StateHasChanged();
        var setting = SelectedShopSetting;
        if (setting == null)
        {
            _groupedThemes = null;
            _isLoading = false;
            StateHasChanged();
            return;
        }

        _groupedThemes = ThemeService.GetThemes(setting.ThemeFolderPath ?? string.Empty, setting.ShopYamlPath ?? string.Empty).ToList();
        ApplyPinnedThemeOrder();
        _isLoading = false;
        StateHasChanged();
    }

    private async Task ThemeOverwriteChanged(ThemeInfo info)
    {
        _isLoading = true;
        StateHasChanged();
        try
        {
            var setting = SelectedShopSetting;
            if (setting == null) return;
            var result = ThemeService.SetThemeOverwrite(setting.ShopYamlPath ?? string.Empty, info);
            if (result)
            {
                await LoadAsync();
                if (Settings.RestartShopOnThemeChange)
                {
                    await IisService.RestartIisApp();
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fehler beim Ändern der Theme-Überschreibung: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task Create(ThemeInfo info)
    {
        var setting = SelectedShopSetting;
        if (setting == null) return;
        ThemeService.CreateLink(setting.ThemeFolderPath ?? string.Empty, info);
        await LoadAsync();
    }

    private async Task Remove(ThemeInfo info)
    {
        var setting = SelectedShopSetting;
        if (setting == null) return;
        ThemeService.RemoveLink(setting.ThemeFolderPath ?? string.Empty, info);
        await LoadAsync();
    }

    private async Task OpenCloneDialog()
    {
        var setting = SelectedShopSetting;
        if (setting == null) return;

        var shopYamlPath = setting.ShopYamlPath ?? string.Empty;
        var shopThemesPath = setting.ThemeFolderPath ?? string.Empty;

        var actions = new List<RepoAction>
        {
            new RepoAction
            {
                Label = "Als Symlink hinzufügen und in shop.yaml eintragen",
                ExecuteAsync = dir => Task.FromResult(ThemeService.LinkAndOverwrite(Path.GetFileName(dir), shopThemesPath, shopYamlPath))
            },
            new RepoAction
            {
                Label = "Nach dem Klonen in Rider öffnen",
                ExecuteAsync = dir => { OpenDirectoryInExplorer(dir); SolutionOpener.OpenSolutionInRider(dir); return Task.FromResult(true); }
            }
        };

        var parameters = new DialogParameters<CloneRepoDialog>
        {
            { x => x.DestinationRoot, Settings.ThemeRepositoryPath },
            { x => x.Actions, actions },
            { x => x.Title, "Theme-Repository klonen" }
        };
        var dlg = await DialogService.ShowAsync<CloneRepoDialog>("Theme klonen", parameters);
        var result = await dlg.Result;
        if (!result.Canceled)
        {
            await LoadAsync();
        }
    }

    private void LoadPinnedThemeGroups()
    {
        _pinnedThemeGroups.Clear();
        var raw = Settings.PinnedThemeGroups;
        if (string.IsNullOrWhiteSpace(raw))
            return;

        foreach (var part in raw.Split(';', StringSplitOptions.RemoveEmptyEntries))
        {
            var key = part.Trim();
            if (!string.IsNullOrWhiteSpace(key))
            {
                _pinnedThemeGroups.Add(key);
            }
        }
    }

    private void ApplyPinnedThemeOrder()
    {
        if (_groupedThemes == null)
            return;

        _groupedThemes = _groupedThemes
            .OrderByDescending(t => _pinnedThemeGroups.Contains(t.Repo))
            .ThenBy(t => t.Repo, StringComparer.OrdinalIgnoreCase)
            .ThenBy(t => t.Name, StringComparer.OrdinalIgnoreCase)
            .ToList();
    }

    private void TogglePinnedThemeGroup(string key)
    {
        if (string.IsNullOrWhiteSpace(key))
            return;

        if (_pinnedThemeGroups.Contains(key))
        {
            _pinnedThemeGroups.Remove(key);
        }
        else
        {
            _pinnedThemeGroups.Add(key);
        }

        Settings.PinnedThemeGroups = string.Join(";", _pinnedThemeGroups);
        SettingsService.SaveSettings();

        ApplyPinnedThemeOrder();
        StateHasChanged();
    }
    
    private string GetShopDisplayName(ShopSetting s)
    {
        var name = IisService.GetSiteNameById(s.SiteId);
        if (!string.IsNullOrWhiteSpace(name)) return name;
        try
        {
            var yamlPath = s.ShopYamlPath ?? string.Empty;
            var dir = System.IO.Path.GetDirectoryName(yamlPath) ?? string.Empty;
            if (string.IsNullOrWhiteSpace(dir)) return yamlPath;

            var segments = dir.Split(new[] { System.IO.Path.DirectorySeparatorChar, System.IO.Path.AltDirectorySeparatorChar }, StringSplitOptions.RemoveEmptyEntries);
            string? candidate = null;

            var idxCustomerRoot = Array.FindIndex(segments, p => p.Equals("KundenShops", StringComparison.OrdinalIgnoreCase));
            if (idxCustomerRoot >= 0 && idxCustomerRoot + 1 < segments.Length)
            {
                candidate = segments[idxCustomerRoot + 1];
            }

            if (candidate == null)
            {
                var idxShopSystem = Array.FindIndex(segments, p => p.Equals("Shopsystem", StringComparison.OrdinalIgnoreCase));
                if (idxShopSystem > 0)
                {
                    candidate = segments[idxShopSystem - 1];
                }
            }

            if (candidate == null)
            {
                for (int i = segments.Length - 1; i >= 0; i--)
                {
                    var seg = segments[i];
                    if (!seg.Equals("Shop", StringComparison.OrdinalIgnoreCase))
                    {
                        candidate = seg;
                        break;
                    }
                }
            }

            if (!string.IsNullOrWhiteSpace(candidate)) return candidate;

            var baseName = System.IO.Path.GetFileName(dir);
            return string.IsNullOrWhiteSpace(baseName) ? dir : baseName;
        }
        catch
        {
            return s.ShopYamlPath;
        }
    }
}



