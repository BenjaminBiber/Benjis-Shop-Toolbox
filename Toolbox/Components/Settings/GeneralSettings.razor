@using Toolbox.Data.Common
@using Toolbox.Data.Models
@using Toolbox.Services
@inject SettingsService SettingsService
@inject FileDialogService FileDialog
@inject NotificationService NotificationService
@inject ISnackbar Snackbar
@inject UpdaterService UpdaterSvc
@using System.Linq

<div class="row g-0 pl-4 flex-column">
    <div class="col-12 mt-3 d-flex gap-1 align-items-center justify-content-center">
        <MudText Class="fw-bold" Typo="Typo.body1">Aktuelle Version</MudText>
        <MudDivider Class="w-auto"></MudDivider>
    </div>
    <div class="col-12 d-flex align-items-center gap-2 pl-4">
        <MudText Class="fw-light" Typo="Typo.body1">@(_currentVersion ?? "unbekannt")</MudText>
    </div>
    
    <div class="col-12 mt-3 d-flex gap-1 align-items-center justify-content-center">
        <MudText Class="fw-bold" Typo="Typo.body1">Themes</MudText>
        <MudDivider Class="w-auto"></MudDivider>
    </div>
    <div class="col-12 d-flex flex-column gap-2">
        <div class="pl-4 d-flex flex-column gap-2">
            <MudText Typo="Typo.caption" Class="fw-bold">Repo Pfade</MudText>
            <MudChipSet T="string" Class="d-flex flex-wrap gap-1">
                @if (_themePaths.Any())
                {
                    @foreach (var path in _themePaths)
                    {
                        <MudChip T="string"
                                 Variant="Variant.Outlined"
                                 Color="Color.Primary"
                                 OnClose="@(() => RemoveThemePath(path))"
                                 Closeable="true">@path</MudChip>
                    }
                }
                else
                {
                    <MudText Typo="Typo.caption" Class="text-secondary">Keine Pfade hinterlegt</MudText>
                }
            </MudChipSet>
            <div class="d-flex gap-2">
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Add"
                           OnClick="AddThemePath">Pfad hinzufügen</MudButton>
            </div>
        </div>
        <MudCheckBox Class="p-0" ValueChanged="(bool i) => SettingsService.SaveSettingChanges(x => x.RestartShopOnThemeChange = i, NotificationService)" Value="Setting.RestartShopOnThemeChange" T="bool" Color="Color.Primary">Shop bei Theme-Wechsel neustarten</MudCheckBox>
    </div>

    <div class="col-12 mt-3 d-flex gap-1 align-items-center justify-content-center">
        <MudText Class="fw-bold" Typo="Typo.body1">Extensions</MudText>
        <MudDivider Class="w-auto"></MudDivider>
    </div>
    <div class="col-12 d-flex flex-column gap-2">
        <div class="pl-4 d-flex flex-column gap-2">
            <MudText Typo="Typo.caption" Class="fw-bold">Repo Pfade</MudText>
            <MudChipSet T="string" Class="d-flex flex-wrap gap-1">
                @if (_extensionPaths.Any())
                {
                    @foreach (var path in _extensionPaths)
                    {
                        <MudChip T="string"
                                 Variant="Variant.Outlined"
                                 Color="Color.Primary"
                                 OnClose="@(() => RemoveExtensionPath(path))"
                                 Closeable="true">@path</MudChip>
                    }
                }
                else
                {
                    <MudText Typo="Typo.caption" Class="text-secondary">Keine Pfade hinterlegt</MudText>
                }
            </MudChipSet>
            <div class="d-flex gap-2">
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Add"
                           OnClick="AddExtensionPath">Pfad hinzufügen</MudButton>
            </div>
        </div>
    </div>
    
    <div class="col-12 mt-3 d-flex gap-1 align-items-center justify-content-center">
        <MudText Class="fw-bold" Typo="Typo.body1">Pfade</MudText>
        <MudDivider Class="w-auto"></MudDivider>
    </div>
    <div class="col-12 d-flex flex-column gap-2">
        <MudTextField ValueChanged="(string i) => SettingsService.SaveSettingChanges(x => x.GeneralFolderPath = i, NotificationService)" Value="Setting.GeneralFolderPath" Label="Shopsystem Ordnerpfad" Variant="Variant.Text" Class="pl-4"
                      Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.FolderOpen" OnAdornmentClick="ChooseGeneralFolder"/>
    </div>
    
    <div class="col-12 mt-3 d-flex gap-1 align-items-center justify-content-center">
        <MudText Class="fw-bold" Typo="Typo.body1">Updater</MudText>
        <MudDivider Class="w-auto"></MudDivider>
    </div>
    <div class="col-12 d-flex align-items-center gap-2 pl-4">
        <MudTooltip Text="Startet den Updater (Administratorrechte erforderlich).">
            <MudButton Variant="MudBlazor.Variant.Outlined"
                       Color="Color.Primary"
                       Disabled="@_startingUpdater"
                       StartIcon="@Icons.Material.Filled.SystemUpdate"
                       OnClick="@RunUpdaterAsync">
                @(_startingUpdater ? "Starte Updater..." : "Updater ausführen")
            </MudButton>
        </MudTooltip>
    </div>
</div>

@code {
    private ToolboxSettings Setting => SettingsService.Settings;
    private string? _currentVersion;
    private bool _startingUpdater;
    private readonly List<string> _themePaths = new();
    private readonly List<string> _extensionPaths = new();

    protected override Task OnInitializedAsync()
    {
        _currentVersion = GetInformationalVersion();
        LoadPathLists();
        return Task.CompletedTask;
    }

    private void LoadPathLists()
    {
        _themePaths.Clear();
        _themePaths.AddRange(Setting.GetThemeRoots());

        _extensionPaths.Clear();
        _extensionPaths.AddRange(Setting.GetExtensionRoots());
    }

    private void AddThemePath()
    {
        var initial = _themePaths.LastOrDefault() ?? Setting.GeneralFolderPath;
        var path = FileDialog.OpenFolder("Theme Repo Ordner auswählen", initial);
        AddPath(path, _themePaths, paths => SettingsService.SaveSettingChanges(x => x.SetThemeRoots(paths), NotificationService));
    }

    private void AddExtensionPath()
    {
        var initial = _extensionPaths.LastOrDefault() ?? Setting.GeneralFolderPath;
        var path = FileDialog.OpenFolder("Extensions Repo Ordner auswählen", initial);
        AddPath(path, _extensionPaths, paths => SettingsService.SaveSettingChanges(x => x.SetExtensionRoots(paths), NotificationService));
    }

    private void AddPath(string path, List<string> target, Action<IEnumerable<string>> saveAction)
    {
        if (string.IsNullOrWhiteSpace(path))
            return;

        var normalized = path.Trim();
        if (target.Any(p => string.Equals(p, normalized, StringComparison.OrdinalIgnoreCase)))
        {
            Snackbar.Add("Pfad ist bereits hinterlegt.", Severity.Info);
            return;
        }

        target.Add(normalized);
        saveAction(target);
        LoadPathLists();
    }

    private void RemoveThemePath(string path)
    {
        RemovePath(path, _themePaths, paths => SettingsService.SaveSettingChanges(x => x.SetThemeRoots(paths), NotificationService));
    }

    private void RemoveExtensionPath(string path)
    {
        RemovePath(path, _extensionPaths, paths => SettingsService.SaveSettingChanges(x => x.SetExtensionRoots(paths), NotificationService));
    }

    private void RemovePath(string path, List<string> target, Action<IEnumerable<string>> saveAction)
    {
        if (string.IsNullOrWhiteSpace(path))
            return;

        target.RemoveAll(p => string.Equals(p, path, StringComparison.OrdinalIgnoreCase));
        saveAction(target);
        LoadPathLists();
    }

    private void ChooseGeneralFolder()
    {
        var path = FileDialog.OpenFolder("Allgemeinen Ordner auswählen", Setting.GeneralFolderPath);
        if (!string.IsNullOrEmpty(path))
        {
            Setting.GeneralFolderPath = path;
        }
    }
    
    private async Task RunUpdaterAsync()
    {
        if (_startingUpdater) return;
        _startingUpdater = true;
        try
        {
            var ok = await UpdaterSvc.TryLaunchUpdaterAsync();
            if (ok)
                Snackbar.Add("Updater gestartet.", Severity.Success, cfg => cfg.VisibleStateDuration = 1500);
            else
                Snackbar.Add("Updater nicht gefunden oder konnte nicht gestartet werden.", Severity.Warning);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fehler beim Starten des Updaters: {ex.Message}", Severity.Error);
        }
        finally
        {
            _startingUpdater = false;
            StateHasChanged();
        }
    }
    
    private static string? GetInformationalVersion()
    {
        try
        {
            var asm = typeof(Program).Assembly;
            var attr = asm.GetCustomAttributes(typeof(System.Reflection.AssemblyInformationalVersionAttribute), false)
                .OfType<System.Reflection.AssemblyInformationalVersionAttribute>()
                .FirstOrDefault();
            var v = attr?.InformationalVersion ?? asm.GetName().Version?.ToString();
            if (!string.IsNullOrEmpty(v))
            {
                var idx = v.IndexOfAny(new[] { '+', '-' });
                if (idx > 0) v = v.Substring(0, idx);
            }

            return v;
        }
        catch
        {
            return null;
        }
    }
}
